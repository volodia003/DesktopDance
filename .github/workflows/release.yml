name: Release Build

on:
  push:
    tags:
      - 'v*' # –¢—Ä–∏–≥–≥–µ—Ä –Ω–∞ —Ç–µ–≥–∏ –≤–∏–¥–∞ v1.0.0

jobs:
  build:
    name: Build and Release
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 7.0.x
    
    - name: Get version from tag
      id: version
      run: |
        $version = $env:GITHUB_REF -replace 'refs/tags/v', ''
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "Version: $version"
      shell: pwsh
    
    - name: Restore dependencies
      run: dotnet restore
    
    - name: Build
      run: dotnet build -c Release --no-restore
    
    - name: Publish Self-Contained
      run: |
        dotnet publish -c Release -r win-x64 --self-contained true `
          -p:PublishSingleFile=true `
          -p:EnableCompressionInSingleFile=true `
          -p:IncludeNativeLibrariesForSelfExtract=true `
          -p:DebugType=None `
          -p:DebugSymbols=false
    
    - name: Create README for release
      run: |
        $readmeContent = @"
        ===========================================
            Desktop Dance ${{ steps.version.outputs.VERSION }}
        ===========================================

        –°–ø–∞—Å–∏–±–æ –∑–∞ –∑–∞–≥—Ä—É–∑–∫—É Desktop Dance!

        üöÄ –ë–´–°–¢–†–´–ô –°–¢–ê–†–¢:
        1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ DesktopDance.exe
        2. –ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Ç—Ä–µ–µ
        3. –í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å!

        üìã –£–ü–†–ê–í–õ–ï–ù–ò–ï:
        - –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –º—ã—à—å—é
        - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–ª–∞–π–¥–µ—Ä –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞
        - –ü–ö–ú –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
        - Del - —É–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        - F2 - –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞

        ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:
        –î–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –∏–∫–æ–Ω–∫—É –≤ —Å–∏—Å—Ç–µ–º–Ω–æ–º —Ç—Ä–µ–µ (–ü–ö–ú ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏)

        üìñ –ü–û–õ–ù–ê–Ø –î–û–ö–£–ú–ï–ù–¢–ê–¶–ò–Ø:
        https://github.com/${{ github.repository }}

        üêõ –ù–ê–®–õ–ò –ë–ê–ì?
        –°–æ–∑–¥–∞–π—Ç–µ Issue: https://github.com/${{ github.repository }}/issues

        üíñ –ü–†–ò–Ø–¢–ù–û–ì–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø!
        ===========================================
        "@
        
        Set-Content -Path "bin\Release\net7.0-windows\win-x64\publish\README.txt" -Value $readmeContent -Encoding UTF8
      shell: pwsh
    
    - name: Create Archive
      run: |
        $archiveName = "Desktop-Dance-v${{ steps.version.outputs.VERSION }}-win-x64.zip"
        Compress-Archive -Path "bin\Release\net7.0-windows\win-x64\publish\*" -DestinationPath $archiveName
        echo "ARCHIVE_NAME=$archiveName" >> $env:GITHUB_OUTPUT
      shell: pwsh
      id: archive
    
    - name: Calculate checksums
      run: |
        $archiveName = "Desktop-Dance-v${{ steps.version.outputs.VERSION }}-win-x64.zip"
        $hash = (Get-FileHash $archiveName -Algorithm SHA256).Hash
        "$hash  $archiveName" | Out-File -FilePath "checksums.txt" -Encoding UTF8
        echo "SHA256: $hash"
      shell: pwsh
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          Desktop-Dance-v${{ steps.version.outputs.VERSION }}-win-x64.zip
          checksums.txt
        body: |
          ## üéâ Desktop Dance v${{ steps.version.outputs.VERSION }}
          
          ### üì• –£—Å—Ç–∞–Ω–æ–≤–∫–∞
          
          1. –°–∫–∞—á–∞–π—Ç–µ `Desktop-Dance-v${{ steps.version.outputs.VERSION }}-win-x64.zip`
          2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ –≤ –ª—é–±—É—é –ø–∞–ø–∫—É
          3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `DesktopDance.exe`
          
          ### ‚ú® –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏
          
          - –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ –Ω–∞ —Ä–∞–±–æ—á–µ–º —Å—Ç–æ–ª–µ
          - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö GIF
          - –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã (–æ–¥–∏–Ω–æ—á–Ω—ã–π/–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π)
          - –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
          - –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å Windows
          - –°–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–µ –≤ —Å–∏—Å—Ç–µ–º–Ω—ã–π —Ç—Ä–µ–π
          
          ### üíª –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
          
          - **–û–°**: Windows 10 –∏–ª–∏ –Ω–æ–≤–µ–µ
          - **–ü–∞–º—è—Ç—å**: –ú–∏–Ω–∏–º—É–º 100 –ú–ë —Å–≤–æ–±–æ–¥–Ω–æ–π RAM
          - **.NET Runtime**: –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è (self-contained —Å–±–æ—Ä–∫–∞)
          
          ### üìã –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
          
          <!-- –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
          
          ### üîí –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
          
          SHA256 —Ö–µ—à-—Å—É–º–º–∞ —É–∫–∞–∑–∞–Ω–∞ –≤ —Ñ–∞–π–ª–µ `checksums.txt`
          
          ### üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
          
          –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ [README.md](https://github.com/${{ github.repository }}/blob/main/README.md)
          
          ### üêõ –°–æ–æ–±—â–∏—Ç—å –æ –ø—Ä–æ–±–ª–µ–º–µ
          
          –ï—Å–ª–∏ –≤—ã –Ω–∞—à–ª–∏ –±–∞–≥, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, [—Å–æ–∑–¥–∞–π—Ç–µ Issue](https://github.com/${{ github.repository }}/issues)
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: Desktop-Dance-v${{ steps.version.outputs.VERSION }}
        path: |
          bin/Release/net7.0-windows/win-x64/publish/
        retention-days: 30

